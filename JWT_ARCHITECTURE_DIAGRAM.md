# Phase-2 JWT Architecture Diagram

## ğŸ—ï¸ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP/WebSocket
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FASTAPI APPLICATION                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PHASE-1 (/api/v1)  â”‚    â”‚   PHASE-2 (/api/v2)      â”‚  â”‚
â”‚  â”‚  (Session-based)     â”‚    â”‚   (JWT-based) âœ¨         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ Email + password   â”‚    â”‚ â€¢ Phone + OTP            â”‚  â”‚
â”‚  â”‚ â€¢ Session ID         â”‚    â”‚ â€¢ Access token (15 min)  â”‚  â”‚
â”‚  â”‚ â€¢ PostgreSQL storage â”‚    â”‚ â€¢ Refresh token (7 days) â”‚  â”‚
â”‚  â”‚ â€¢ Cookie-based       â”‚    â”‚ â€¢ Redis storage          â”‚  â”‚
â”‚  â”‚ â€¢ UNTOUCHED âœ“        â”‚    â”‚ â€¢ Header-based âœ¨        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         â”‚         â”‚
                    â–¼         â–¼         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚PostgreSQLâ”‚ â”‚  Redis   â”‚ â”‚ External â”‚
            â”‚ (Source  â”‚ â”‚(Ephemeral)â”‚ â”‚Services  â”‚
            â”‚of Truth) â”‚ â”‚           â”‚ â”‚          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Login & Auth Flow

```
CLIENT                          BACKEND                       STORAGE
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€â”€â”€ POST /send-otp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Validate phone            â”‚
  â”‚                               â”‚  in PostgreSQL              â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ PG
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Generate 6-digit OTP     â”‚
  â”‚                               â”œâ”€ Store in Redis            â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [otp:{phone}] TTL=5min    â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€ 200 OK (phone) â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚ [User enters OTP from console]                              â”‚
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€â”€â”€ POST /verify-otp â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚    {phone, otp_code}          â”‚                             â”‚
  â”‚                               â”œâ”€ Fetch OTP from Redis     â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Compare & validate       â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Generate access token    â”‚
  â”‚                               â”‚  (15 min) with jti         â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Generate refresh token   â”‚
  â”‚                               â”‚  (7 days) with jti         â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Store refresh in Redis   â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [jwt:refresh:{jti}]       â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€â”€â”€ 200 + tokens + user â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚    {access, refresh, user}    â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚ [Client stores tokens locally]â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€ GET /protected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚    Authorization: Bearer      â”‚                             â”‚
  â”‚    <access_token>             â”‚                             â”‚
  â”‚                               â”œâ”€ Extract JWT              â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Verify signature         â”‚
  â”‚                               â”‚ â”œâ”€ Check expiry           â”‚
  â”‚                               â”‚ â””â”€ Check blacklist        â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [jwt:blacklist:{jti}]     â”‚
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Extract user_id, role   â”‚
  â”‚                               â”œâ”€ Run endpoint logic       â”‚
  â”‚                               â”œâ”€ Access DB if needed      â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ PG
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€â”€â”€â”€ 200 + response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚ [After 15 minutes, token expires]                           â”‚
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€ POST /refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚    {refresh_token}            â”‚                             â”‚
  â”‚                               â”œâ”€ Decode refresh token    â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Check if exists Redis   â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [jwt:refresh:{jti}]       â”‚
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Generate NEW access     â”‚
  â”‚                               â”‚  token with NEW jti       â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€â”€â”€â”€ 200 + new access â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚ [User continues using service]â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€ POST /logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚    Authorization: Bearer      â”‚                             â”‚
  â”‚                               â”œâ”€ Extract jti from token  â”‚
  â”‚                               â”‚                             â”‚
  â”‚                               â”œâ”€ Blacklist jti           â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [jwt:blacklist:{jti}]     â”‚
  â”‚                               â”‚  TTL = remaining lifetime  â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€â”€â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”‚ [Token now blacklisted]       â”‚                             â”‚
  â”‚                               â”‚                             â”‚
  â”œâ”€â”€ GET /protected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
  â”‚    Authorization: Bearer      â”‚                             â”‚
  â”‚    <same_token>               â”‚                             â”‚
  â”‚                               â”œâ”€ Extract JWT              â”‚
  â”‚                               â”‚ â”œâ”€ Check blacklist        â”‚
  â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis
  â”‚                               â”‚  [jwt:blacklist:{jti}]     â”‚
  â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                               â”‚  âœ“ Found (blacklisted!)   â”‚
  â”‚                               â”‚                             â”‚
  â”‚â—€â”€ 401 "Token revoked" â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
  â”‚                               â”‚                             â”‚

Legend:
  â–¶ = Request
  â—€ = Response
  PG = PostgreSQL Database
```

---

## ğŸ“¦ JWT Token Contents

### Access Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Access Token (15 minutes)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Header:                                                   â”‚
â”‚  {                                                         â”‚
â”‚    "alg": "HS256",                                        â”‚
â”‚    "typ": "JWT"                                           â”‚
â”‚  }                                                         â”‚
â”‚                                                            â”‚
â”‚ Payload:                                                  â”‚
â”‚  {                                                         â”‚
â”‚    "user_id": 5,                                          â”‚
â”‚    "phone_number": "+919876543210",                       â”‚
â”‚    "role": "driver",                                      â”‚
â”‚    "jti": "550e8400-e29b-41d4-a716-446655440000",        â”‚
â”‚    "iat": 1704067200,          â† issued at               â”‚
â”‚    "exp": 1704068100            â† expiry (15 min later)  â”‚
â”‚  }                                                         â”‚
â”‚                                                            â”‚
â”‚ Signature: HMAC-SHA256(header.payload, SECRET_KEY)       â”‚
â”‚                                                            â”‚
â”‚ Result: "eyJhbGc..." (base64url encoded)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Refresh Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Refresh Token (7 days)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload:                                                  â”‚
â”‚  {                                                         â”‚
â”‚    "user_id": 5,                                          â”‚
â”‚    "phone_number": "+919876543210",                       â”‚
â”‚    "role": "driver",                                      â”‚
â”‚    "jti": "660e8400-e29b-41d4-a716-446655440000",        â”‚
â”‚    "token_type": "refresh",      â† distinguishes from    â”‚
â”‚    "iat": 1704067200,                access token        â”‚
â”‚    "exp": 1704672000             â† expiry (7 days later) â”‚
â”‚  }                                                         â”‚
â”‚                                                            â”‚
â”‚ (Same signature mechanism as access token)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Verification Process

```
REQUEST arrives with: Authorization: Bearer <access_token>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Decode JWT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Split token into 3 parts (.)              â”‚
â”‚ â€¢ Base64-decode header and payload         â”‚
â”‚ â€¢ Extract jti: "550e8400-..."              â”‚
â”‚ â€¢ Extract user_id: 5                       â”‚
â”‚ â€¢ Extract expiry (exp): 1704068100         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Verify Signature                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Compute: HMAC-SHA256(header.payload,     â”‚
â”‚           SECRET_KEY)                      â”‚
â”‚ â€¢ Compare with provided signature           â”‚
â”‚ â€¢ If mismatch â†’ 401 "Invalid token"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Check Expiry                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Current timestamp: now()                  â”‚
â”‚ â€¢ If now > exp â†’ 401 "Token expired"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Check Redis Blacklist               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Query: EXISTS jwt:blacklist:550e8400-... â”‚
â”‚ â€¢ If EXISTS â†’ 401 "Token revoked"          â”‚
â”‚ â€¢ If NOT exists â†’ Continue âœ“               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Token Valid                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Endpoint receives:                          â”‚
â”‚ {                                           â”‚
â”‚   "user_id": 5,                            â”‚
â”‚   "phone_number": "+919876543210",         â”‚
â”‚   "role": "driver",                        â”‚
â”‚   "jti": "550e8400-..."                    â”‚
â”‚ }                                           â”‚
â”‚                                             â”‚
â”‚ Proceed with request âœ“                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Redis Key Structure

```
OTP Phase
â”œâ”€â”€ otp:{phone}                 â† OTP code
â”‚   â”‚  Format: otp:+919876543210
â”‚   â”‚  Value: "123456"
â”‚   â”‚  TTL: 5 minutes
â”‚   â”‚
â”œâ”€â”€ otp:attempts:{phone}        â† Failed attempts
â”‚   â”‚  Format: otp:attempts:+919876543210
â”‚   â”‚  Value: 2 (increments)
â”‚   â”‚  TTL: 5 minutes
â”‚   â”‚
â””â”€â”€ otp:lockout:{phone}         â† Account lock
    Format: otp:lockout:+919876543210
    Value: "locked"
    TTL: 15 minutes (after 3 failures)

JWT Phase
â”œâ”€â”€ jwt:refresh:{jti}           â† Refresh token storage
â”‚   â”‚  Format: jwt:refresh:660e8400-e29b-...
â”‚   â”‚  Value: {"user_id": 5, "phone": "+..."}
â”‚   â”‚  TTL: 7 days
â”‚   â”‚
â””â”€â”€ jwt:blacklist:{jti}         â† Revoked tokens
    Format: jwt:blacklist:550e8400-e29b-...
    Value: "revoked"
    TTL: 15 minutes (remaining token lifetime)
```

---

## ğŸ›¡ï¸ Security Layers

```
Layer 1: OTP Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Random 6-digit code                   â”‚
â”‚ â€¢ 5-minute expiry                       â”‚
â”‚ â€¢ Max 3 attempts                        â”‚
â”‚ â€¢ 15-minute lockout after max attempts  â”‚
â”‚ â€¢ Phone-only (no email bypass)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
Layer 2: Token Generation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Access token: 15 minutes              â”‚
â”‚ â€¢ Refresh token: 7 days                 â”‚
â”‚ â€¢ Unique jti per token                  â”‚
â”‚ â€¢ HS256 signature with secret           â”‚
â”‚ â€¢ No sensitive data in payload          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
Layer 3: Token Verification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Signature verification (HS256)        â”‚
â”‚ â€¢ Expiry checking                       â”‚
â”‚ â€¢ Redis blacklist lookup                â”‚
â”‚ â€¢ All 3 checks required                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
Layer 4: Authorization
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Role-based access (require_role)      â”‚
â”‚ â€¢ User identity (current_user)          â”‚
â”‚ â€¢ Endpoint-specific checks              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š State Diagram

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  NO AUTH     â”‚
                      â”‚  (New User)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    send-otp endpoint
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  OTP SENT    â”‚
                      â”‚  (5 min TTL) â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    verify-otp endpoint
                      (max 3 attempts)
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ AUTHENTICATED  â”‚
                      â”‚ (With tokens)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚             â”‚             â”‚
        Access token    Refresh token    logout
        (15 min)         (7 days)       endpoint
               â”‚             â”‚             â”‚
        Access API      Get new          â”‚
        & WebSocket      access          â”‚
               â”‚             â”‚             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                      â”‚ BLACKLISTED â”‚
                      â”‚ (Logged Out)â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                        Must login again
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  NO AUTH     â”‚
                      â”‚  (Restart)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ File Organization

```
backend/app/
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ jwt_utils.py               â† Token generation/decode
â”‚       â””â”€â”€ generate_access_token()
â”‚       â””â”€â”€ generate_refresh_token()
â”‚       â””â”€â”€ decode_token()
â”‚
â”œâ”€â”€ core/redis/
â”‚   â”œâ”€â”€ keys.py                    â† Key definitions
â”‚   â”‚   â””â”€â”€ JWT_BLACKLIST_KEY
â”‚   â”‚   â””â”€â”€ JWT_REFRESH_TOKEN_KEY
â”‚   â”‚
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ jwt_store.py           â† JWT Redis operations
â”‚           â””â”€â”€ blacklist_access_token()
â”‚           â””â”€â”€ is_access_token_blacklisted()
â”‚           â””â”€â”€ store_refresh_token()
â”‚           â””â”€â”€ get_refresh_token()
â”‚
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ deps/
â”‚   â”‚   â””â”€â”€ jwt_auth.py            â† Auth dependencies
â”‚   â”‚       â””â”€â”€ verify_jwt()
â”‚   â”‚       â””â”€â”€ get_current_user()
â”‚   â”‚       â””â”€â”€ require_role()
â”‚   â”‚
â”‚   â””â”€â”€ v2/                        â† PHASE-2 Routes
â”‚       â”œâ”€â”€ auth.py                â† OTP login/refresh/logout
â”‚       â”‚   â””â”€â”€ send-otp
â”‚       â”‚   â””â”€â”€ verify-otp
â”‚       â”‚   â””â”€â”€ refresh
â”‚       â”‚   â””â”€â”€ logout
â”‚       â”‚
â”‚       â””â”€â”€ test.py                â† Protected endpoints
â”‚           â””â”€â”€ /protected
â”‚           â””â”€â”€ /driver-only
â”‚           â””â”€â”€ /admin-only
â”‚
â””â”€â”€ schemas/
    â””â”€â”€ jwt_auth.py                â† Request/response models
        â””â”€â”€ SendOTPRequest
        â””â”€â”€ VerifyOTPRequest
        â””â”€â”€ JWTTokenResponse
        â””â”€â”€ RefreshTokenRequest
        â””â”€â”€ RefreshTokenResponse
```

---

This architecture provides:
âœ… Clean separation of concerns
âœ… Stateless access tokens (scalable)
âœ… Server-side refresh tokens (revocation control)
âœ… Redis-backed revocation (fast blacklist checks)
âœ… OTP security with lockout
âœ… Role-based access control
âœ… 100% phase isolation
