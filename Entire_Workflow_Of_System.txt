COMPLETE SYSTEM WORKFLOW (LOCKED)

This is the final mental model of your platform.

1Ô∏è‚É£ ACTORS IN THE SYSTEM
üë§ Users (OTP-based)

Rider

Driver

Fleet Owner (Business)

üßë‚Äçüíº Admins (Email + Password)

Platform Admin

Tenant Admin

Admins and Users are completely separate flows.

2Ô∏è‚É£ AUTHENTICATION & IDENTITY
Users

Login via Phone + OTP

On first OTP verification:

app_user row is created (minimal data)

JWT is issued

User is always a Rider by default

Admins

Login via email/password

Session-based auth

No OTP, no JWT, no onboarding

3Ô∏è‚É£ CORE DATA PRINCIPLES (VERY IMPORTANT)

app_user = identity

Roles like Driver / Fleet Owner are capabilities, not flags

Capabilities are inferred by existence of related records

No user_roles table

4Ô∏è‚É£ DRIVER WORKFLOW
Step 1: Driver Apply

Any logged-in user can apply as driver

driver_profile is created with:

approval_status = PENDING

Driver uploads documents:

Driving License

Aadhaar

Photo

Documents stored in user_kyc

No vehicle categories set yet

Step 2: Tenant Admin Reviews Driver

Tenant admin views:

Driver profile

Uploaded documents

Admin decides:

Approve or Reject driver

On approval:

driver_profile.approval_status = APPROVED

Admin sets allowed_vehicle_categories

e.g. ['BIKE', 'AUTO']

üëâ Driver cannot self-declare allowed vehicles

5Ô∏è‚É£ FLEET CONCEPT (CRITICAL DECISION)
Fleet = Vehicle Ownership Unit

Not necessarily a company.

There are two fleet types:

üöó INDIVIDUAL Fleet

Represents a single driver‚Äôs ownership

Auto-created when driver is approved

fleet_type = INDIVIDUAL

approval_status = APPROVED

No company documents

Used only for that driver‚Äôs vehicles

Driver never manually applies for this fleet.

üè¢ BUSINESS Fleet

Explicitly created by fleet owners

fleet_type = BUSINESS

Requires company documents (fleet_document)

Approved by tenant admin

Can manage multiple vehicles and drivers

6Ô∏è‚É£ VEHICLE OWNERSHIP (VERY IMPORTANT)

Every vehicle belongs to a fleet

Vehicles NEVER belong directly to drivers

Driver adds vehicles under their INDIVIDUAL fleet

Fleet owners add vehicles under their BUSINESS fleet

This keeps schema clean and scalable.

7Ô∏è‚É£ VEHICLE ADDING RULES
Common rules

Fleet must exist

Fleet must be APPROVED

Backend resolves fleet automatically (frontend does not pass fleet_id)

üöó Individual Fleet (Driver)

Driver must be APPROVED

allowed_vehicle_categories must be set

Vehicle category must be allowed by license

‚ùå Bike license ‚Üí cannot add Car
‚úÖ Auto license ‚Üí can add Auto only

üè¢ Business Fleet

No license-category restriction

Vehicle assignment handled later

8Ô∏è‚É£ VEHICLE ONBOARDING FLOW

Vehicle onboarding happens in steps:

Create Vehicle (basic record)

Add Vehicle Specs

Upload Vehicle Documents (RC, Insurance)

Upload Vehicle Photos

All files:

Uploaded by frontend

Backend stores URLs only

9Ô∏è‚É£ DASHBOARD & ACCESS BEHAVIOR

Dashboards are always visible

Actions are gated at API level

Driver Dashboard

Not applied ‚Üí show ‚ÄúApply‚Äù

Pending ‚Üí show ‚ÄúUnder Review‚Äù

Approved ‚Üí full access

Same pattern for fleet owners.

10Ô∏è‚É£ PROFILE MANAGEMENT

app_user is created at OTP time with minimal data

User completes profile later:

Name

Gender

City

Profile can be updated

Profile cannot be deleted

11Ô∏è‚É£ WHAT ADMINS DO
Platform Admin

Create tenants

Create tenant admins

View everything

Tenant Admin

Approve drivers

Set allowed vehicle categories

Approve fleets (business)

Review vehicle documents

Admins do not go through user onboarding.

12Ô∏è‚É£ KEY LOCKED DESIGN DECISIONS (READ THIS)

Fleet is an ownership unit, not always a company

Individual drivers get auto-created fleets

Vehicle ownership is always via fleet

Allowed vehicle categories are set by admin, not driver

No role flags for driver/fleet owner in app_user

No user_roles table

Backend never handles file uploads

üß† ONE-LINE SYSTEM SUMMARY (VERY USEFUL)

Users authenticate via OTP, apply for capabilities, admins approve them, fleetsfleets

IMPORTANT CLARIFICATION ‚Äì ENTITY CREATION RULES

1. Driver Apply Flow
- When a user applies as a driver:
  - ONLY a row is created in `driver_profile`
  - approval_status = PENDING
  - NO fleet is created at this stage
  - allowed_vehicle_categories MUST be NULL

- Driver apply is ONLY an application, not approval.

- Fleet for driver MUST NOT be created during driver apply.

- Fleet creation for driver happens ONLY AFTER tenant admin approval.



2. Fleet Owner Apply Flow (BUSINESS)

- When a user applies as a fleet owner (business):
  - ONLY a row is created in the fleet application context
    (i.e., an unapproved fleet record with approval_status = PENDING)
  - This represents a fleet owner application, NOT an approved fleet.

- Vehicles MUST NOT be allowed at this stage.

- This row is considered "pending fleet application".



3. Tenant Admin Approval (VERY IMPORTANT)

- ONLY TENANT ADMIN can approve applications
- Platform admin MUST NOT approve drivers or fleets

Approval behavior:

A) Driver Approval:
- Tenant admin approves driver_profile
- Tenant admin sets allowed_vehicle_categories
- AFTER approval:
    ‚Üí Create a row in `fleet` with:
       - owner_user_id = driver_id
       - fleet_type = INDIVIDUAL
       - approval_status = APPROVED
- This fleet represents the driver's individual fleet

B) Fleet Owner (Business) Approval:
- Tenant admin approves the pending fleet
- Update approval_status = APPROVED
- fleet_type = BUSINESS



4. HARD RULES (DO NOT VIOLATE)

- Fleet rows MUST NOT be created at apply time for drivers
- Fleet rows MUST NOT be auto-created by users
- Fleet rows MUST be created/approved ONLY by tenant admin action
- Vehicles can be added ONLY AFTER:
    - Fleet exists
    - Fleet.approval_status = APPROVED

Tenant lifecycle is managed OFFLINE and created ONLY by Platform Admin
CREATE UNIQUE INDEX uq_driver_one_active_shift
ON driver_shift (driver_id)
WHERE ended_at IS NULL;

SYSTEM CONTEXT:
This module manages REAL-TIME DRIVER AVAILABILITY and SHIFT LIFECYCLE.
It uses the existing `driver_shift` table.
This is the final operational layer before dispatch.

------------------------------------------------------------

TABLE SEMANTICS (IMPORTANT):

- driver_work_availability:
    Planning-level availability (days/weeks)
    NOT real-time
    NOT shift

- driver_vehicle_assignment:
    Active vehicle usage
    One active row = one vehicle in use

- driver_shift:
    One row = one ONLINE session
    started_at = went ONLINE
    ended_at = went OFFLINE
    status = ONLINE | BUSY | OFFLINE

- driver_location:
    Last known GPS position

------------------------------------------------------------

GLOBAL ELIGIBILITY (MUST PASS ALL):

Driver MUST:
- be authenticated
- have APPROVED driver_profile
- have exactly ONE ACTIVE fleet association
- have exactly ONE ACTIVE driver_vehicle_assignment
- belong to an APPROVED fleet
- have no ACTIVE shift

If ANY check fails ‚Üí reject availability actions.

------------------------------------------------------------

START SHIFT (GO ONLINE):

POST /api/v2/driver/availability/online

Preconditions:
- No active driver_shift (ended_at IS NULL)
- Active driver_vehicle_assignment exists
- Vehicle belongs to driver's ACTIVE fleet
- Vehicle documents are complete

Actions:
- INSERT into driver_shift:
    - driver_id
    - tenant_id (resolved from fleet)
    - status = 'ONLINE'
    - started_at = now()
    - ended_at = NULL

Effects:
- Driver becomes ONLINE
- Driver is now dispatchable

Rejections:
- Active shift already exists
- Missing assignment
- Fleet/vehicle mismatch

------------------------------------------------------------

GO OFFLINE (END SHIFT):

POST /api/v2/driver/availability/offline

Preconditions:
- Active driver_shift exists
- driver_shift.status != 'BUSY'

Actions:
- UPDATE driver_shift:
    - status = 'OFFLINE'
    - ended_at = now()

Effects:
- Driver becomes OFFLINE
- Shift is closed
- Vehicle assignment remains (until explicitly ended)

------------------------------------------------------------

TRIP STATE INTEGRATION (SYSTEM CONTROLLED):

On TRIP ACCEPT:
- UPDATE active driver_shift:
    - status = 'BUSY'

On TRIP COMPLETE or CANCEL:
- UPDATE active driver_shift:
    - status = 'ONLINE'

Rules:
- Driver CANNOT manually change status while BUSY
- BUSY is system-controlled only

------------------------------------------------------------

END VEHICLE ASSIGNMENT (SHIFT MUST BE OFFLINE):

POST /api/v2/driver/shift/end

Eligibility:
- Driver OR Fleet Owner
- Driver must have:
    - no active shift (OFFLINE)
    - active driver_vehicle_assignment

Actions:
- UPDATE driver_vehicle_assignment:
    - end_time = now()

Effects:
- Driver has NO active assignment
- Driver must be reassigned before next shift

------------------------------------------------------------

LOCATION UPDATES:

POST /api/v2/driver/location

Eligibility:
- Active driver_shift exists
- status IN ('ONLINE', 'BUSY')

Actions:
- UPSERT into driver_location
- INSERT into driver_location_history

------------------------------------------------------------

HARD GUARANTEES (NON-NEGOTIABLE):

- One active shift per driver (DB enforced)
- One active vehicle assignment per driver (DB enforced)
- Driver can be ONLINE only with assignment
- Driver can be BUSY only during trip
- Backend is the single source of truth

------------------------------------------------------------

MENTAL MODEL (WRITE THIS IN COMMENTS):

"Planning decides WHO can work.
Assignment decides WHAT they drive.
Shift decides WHEN they are online."
